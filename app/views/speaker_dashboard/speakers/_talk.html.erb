<div class="card-body">
  <h4 class="card-title session-title">
    <%= talk.title %>
    <%= link_to (image_tag "icons/box-arrow-up-right.svg"), proposal_path(id: talk.proposal.id) %>
  </h4>
  <% if talk.talk_category.present? %>
    <h6 class="card-subtitle mb-2 text-muted"><%= talk.talk_category.name %> /
      <%= talk.proposal_item_value('session_time') || "#{talk.talk_time&.time_minutes}分" %></h6>
  <% end %>

  <% if talk.proposal.present? %>
    <h5 class="card-title">
      受付状況
    </h5>
    <div class="card-text">
      <%= talk.proposal.status_message %>
    </div>
  <% end %>

  <h5 class="card-title">
    共同発表者
  </h5>
  <div class="card-text">
    <% if talk.speaker_invitations.size > 0 %>
      <ul>
        <% talk.speaker_invitations.each do |invitation| %>
          <li><%= invitation.email %>(<%= invitation.speaker_invitation_accept.present? ? '共同発表者として登録済み' : '共同発表者として招待済み' %>)</li>
        <% end %>
      </ul>
    <% else %>
      <p>共同発表者は登録されていません</p>
    <% end %>
    <p>追加するには、<%= link_to 'こちら', new_speaker_invitation_path(talk_id: talk.id) %> から招待を行ってください。</p>
  </div>

  <h5 class="card-title">
    概要
  </h5>
  <div class="card-text">
    <%= simple_format talk.abstract %>
  </div>

  <h5 class="card-title">
    セッション資料公開URL
  </h5>
  <div class="card-text">
    <% if talk.document_url.present? %>
      <%= link_to talk.document_url, talk.document_url %>
    <% else %>
      セッション資料公開URLはまだ追加されていません
    <% end %>
  </div>

  <h5 class="card-title">
    ビデオファイル提出状況
  </h5>

  <div class="card-text">
    <% if talk.video_registration %>
      <%= talk.video_registration.status_message %>
    <% else %>
      未確認<br/>
      ※アップロードからステータス反映まで30分程度かかることがあります
    <% end %>
  </div>


  <% if talk.video_registration&.statistics.present? %>
    <h5 class="card-title">
      ビデオファイル フォーマットチェック
    </h5>
    <div class="card-text video-format">
      <table class="table table-striped">
        <% JSON.parse(talk.video_registration.statistics).each do |k,v| %>
          <tr>
            <th><%= k %></th>
            <td><%= v %></td>
          </tr>
        <% end %>
      </table>
    </div>
  <% end %>

  <% if talk.video_registration&.url.present? %>
    <a href="<%= talk.video_registration.url %>" class="btn btn-primary">ビデオファイルアップロード</a>
  <% end %>

  <% if @conference.opened? || @conference.closed? || @conference.archived? %>
    <h5 class="card-title">
      このセッションへの質問
    </h5>

    <div class="card-text qa">
      <% questions = talk.session_questions.includes(:profile, :session_question_answers, :session_question_votes).order_by_time %>
      <% if questions.any? %>
        <% questions.each do |question| %>
          <div class="mb-3 p-3" style="border: 1px solid #dee2e6; border-radius: 4px;">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="flex-grow-1">
                <strong>Q:</strong> <%= simple_format(h(question.body)) %>
                <div class="text-muted small mt-1">
                  質問者: <%= question.profile.public_name %>
                  <span class="ms-2">投票数: <%= question.votes_count %></span>
                  <span class="ms-2"><%= question.created_at.strftime('%Y/%m/%d %H:%M') %></span>
                </div>
              </div>
            </div>

            <% if question.session_question_answers.any? %>
              <div class="mt-2 ms-3">
                <% question.session_question_answers.order_by_time.each do |answer| %>
                  <div class="mb-2 p-2" style="background-color: #f8f9fa; border-radius: 4px;">
                    <strong>A:</strong> <%= simple_format(h(answer.body)) %>
                    <div class="text-muted small mt-1">
                      回答者: <%= answer.speaker.name %>
                      <span class="ms-2"><%= answer.created_at.strftime('%Y/%m/%d %H:%M') %></span>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- 回答フォーム -->
            <%= form_with url: speaker_dashboard_talk_session_question_answer_path(talk_id: talk.id, session_question_id: question.id, event: @conference.abbr), method: :post, local: true, class: 'mt-2' do |f| %>
              <div class="mb-2">
                <%= f.text_area :body, class: 'form-control form-control-sm', rows: 2, placeholder: '回答を入力してください（最大512文字）', maxlength: 512, required: true %>
              </div>
              <%= f.submit '回答する', class: 'btn btn-primary btn-sm' %>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <p class="text-muted">まだ質問がありません</p>
      <% end %>
    </div>
  <% end %>
</div>
