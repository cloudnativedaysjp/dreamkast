<% if f.object&.errors&.any? %>
  <div id="error_explanation" class="alert alert-danger" role="alert">
    <h5>入力内容にエラーがあります:</h5>
    <ul>
      <% f.object.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<div class="talk-field">
  <% if f.object.persisted? %>
    <%= hidden_field_tag "speaker[talks_attributes][#{form_index}][id]", f.object.id %>
  <% end %>

  <div class="field pb-3">
    <%= label_tag "speaker_talks_attributes_#{form_index}_title", '講演タイトル - Abstract Title（★★★）', class: 'form-label' %>*
    <p class="field-description" style="font-size: 0.7em">（最大60文字）受講者の目を引くようなるべく具体的なテクノロジー名を含めることをおすすめします - (Maximum 60 characters) Include concrete technology names as possible to attract attendees</p>
    <%= text_field_tag "speaker[talks_attributes][#{form_index}][title]", f.object.title, class: "form-control", required: true %>
  </div>

  <div class="field pb-3">
    <%= label_tag "speaker_talks_attributes_#{form_index}_abstract", '講演内容 - Abstract（★★★）', class: 'form-label' %>
    <p class="field-description" style="font-size: 0.7em">（最大500文字）どんな人に向けた講演かこの講演によって受講者がどんな情報を得られるかを含めることをおすすめします - (Maximum 500 letters) Include a session for what kind of person, what kind of information the attendee can get</p>
    <%= text_area_tag "speaker[talks_attributes][#{form_index}][abstract]", f.object.abstract, class: "form-control abstract" %>
  </div>

  <% unless ['cicd2021', 'o11y2022', 'cnsec2022', 'cicd2023'].include?(@conference.abbr) %>
    <div class="field pb-3">
      <%= label_tag "speaker_talks_attributes_#{form_index}_talk_category_id", "主なカテゴリ - Main Category（★★）", class: 'form-label' %>*
      <p class="field-description" style="font-size: 0.7em">必ずしもCNCFのプロジェクトに関する内容でなくても問題ありません - It does not necessarily have to be content of the CNCF project</p>
      <%= collection_select nil, "speaker[talks_attributes][#{form_index}][talk_category_id]", @conference.talk_categories, :id, :name, {prompt: "", selected: f.object.talk_category_id}, class: "form-control talk-categories", required: true %>
    </div>
  <% end %>

  <div class="field pb-3">
    <%= label_tag "speaker_talks_attributes_#{form_index}_talk_difficulty_id", "受講者レベル - Audience Experience Level（★★）", class: 'form-label' %>*
    <%= collection_select nil, "speaker[talks_attributes][#{form_index}][talk_difficulty_id]", @conference.talk_difficulties, :id, :name, {prompt: "", selected: f.object.talk_difficulty_id}, class: "form-control", required: true %>
  </div>

  <% if @conference.speaker_entry_disabled? %>
  <div class="field pb-3">
    <%= label_tag "speaker_talks_attributes_#{form_index}_document_url", "セッション資料公開URL", class: 'form-label' %>
    <%= text_field_tag "speaker[talks_attributes][#{form_index}][document_url]", f.object.document_url, class: "form-control" %>
  </div>
  <% end %>

  <% @conference.proposal_item_configs.map(&:item_number).uniq.each do |item_number| %>
    <div class="field pb-3">
      <% first_item = @conference.proposal_item_configs.find_by(item_number: item_number) %>

      <% if first_item.class.to_s == 'ProposalItemConfigCheckBox' %>
        <% existing_items = f.object&.persisted? ? f.object.proposal_items.find_by(label: first_item.label)&.params : []%>
        <%= label_tag "speaker_talks_attributes_#{form_index}_#{first_item.label}",  first_item.item_name, {class: 'form-check-label'}%>*
        <div class="form-check">
          <% @conference.proposal_item_configs.where(item_number: item_number).each do |item|%>
            <% label = item.label.pluralize.to_sym %>
            <% checked = existing_items ? existing_items.include?(item.id.to_s) : false%>
            <%= check_box_tag "speaker[talks_attributes][#{form_index}][#{label}][]", item.id, checked, {id: "#{label}_#{item.params}", class: 'form-check-input'} %>
            <%= label label, item.params, {class: 'form-check-label'} %><br>
          <% end %>
        </div>

      <% elsif first_item.class.to_s == 'ProposalItemConfigRadioButton' %>
        <% existing_items = f.object&.persisted? ? f.object.proposal_items.find_by(label: first_item.label)&.params : []%>
        <%= label_tag "speaker_talks_attributes_#{form_index}_#{first_item.label}[]",  first_item.item_name, {class: 'form-check-label'}%>*<br>
        <p class="field-description" style="font-size: 0.7em"><%= first_item.description&.html_safe %></p>
        <% @conference.proposal_item_configs.where(item_number: item_number).each do |item|%>
          <% label = first_item.label.pluralize.to_sym %>
          <% checked = existing_items ? existing_items.include?(item.id.to_s) : false%>
          <% classes = "radio_button_#{label}" %>
          <% case item.label %>
          <% when 'presentation_method' then %>
            <%= render 'speaker_dashboard/speakers/presentation_method', f: f, existing_items: existing_items, first_item: first_item, item: item, classes: classes, label: label, checked: checked, form_index: form_index %>
          <% when 'session_time' then %>
            <%= render 'speaker_dashboard/speakers/session_times', f: f, existing_items: existing_items, first_item: first_item, item: item, classes: classes, label: label, checked: checked, form_index: form_index %>
          <% else %>
            <%= radio_button_tag "speaker[talks_attributes][#{form_index}][#{label}]", item.id, checked, {required: true, class: classes, params: item.params, id: "#{label}_#{item.params}"} %>
            <%= label label, item.params, {class: 'form-check-label'} %><br>
          <% end %>
        <% end %>
      <% else %>
      <% end %>
    </div>
  <% end %>

  <% if @sponsor %>
    <%= hidden_field_tag "speaker[talks_attributes][#{form_index}][sponsor_id]", @sponsor.id %>
    <%= hidden_field_tag "speaker[talks_attributes][#{form_index}][type]", 'SponsorSession' %>
  <% else %>
    <%= hidden_field_tag "speaker[talks_attributes][#{form_index}][type]", 'Session' %>
  <% end %>

  <%= hidden_field_tag "speaker[talks_attributes][#{form_index}][_destroy]", "false", class: "destroy_flag_field" %>
  <%= hidden_field_tag "speaker[talks_attributes][#{form_index}][conference_id]", @conference.id %>

  <% if @conference.speaker_entry_enabled? || admin? %>
    <%= link_to 'Delete Talk', '#', class: 'remove_talk_field btn btn-danger' %>
  <% end %>

  <hr>
</div>
