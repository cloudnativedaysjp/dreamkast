<%= turbo_frame_tag "question_#{question.id}" do %>
  <div class="mb-4 p-3" style="border: 1px solid #dee2e6; border-radius: 4px;" id="question_<%= question.id %>">
    <div class="mb-2">
      <strong>セッション:</strong> 
      <%= link_to question.talk.title, talk_path(id: question.talk.id, event: @conference&.abbr || event_name), target: '_blank' %>
    </div>
    
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div class="flex-grow-1">
        <strong>Q:</strong> <%= simple_format(question.body) %>
        <div class="text-muted small mt-1">
          <% profile = question.profile %>
          <% profile_name = if profile.public_profile&.nickname.present?
                              profile.public_profile.nickname
                            elsif profile.last_name.present? || profile.first_name.present?
                              "#{profile.last_name} #{profile.first_name}".strip
                            else
                              '匿名ユーザー'
                            end %>
          質問者: <%= profile_name %>
          <span class="ms-2">投票数: <%= question.votes_count %></span>
          <span class="ms-2"><%= question.created_at.strftime('%Y/%m/%d %H:%M') %></span>
        </div>
      </div>
    </div>

    <%= turbo_frame_tag "answers_#{question.id}" do %>
      <% if question.session_question_answers.any? %>
        <div class="mt-2 ms-3">
          <% question.session_question_answers.order_by_time.each do |answer| %>
            <%= turbo_frame_tag "answer_#{answer.id}" do %>
              <div class="mb-2 p-2" style="background-color: #f8f9fa; border-radius: 4px;">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <strong>A:</strong> <%= simple_format(answer.body) %>
                    <div class="text-muted small mt-1">
                      回答者: <%= answer.speaker.name %>
                      <span class="ms-2"><%= answer.created_at.strftime('%Y/%m/%d %H:%M') %></span>
                    </div>
                  </div>
                  <% if @speaker && answer.speaker_id == @speaker.id %>
                    <div class="ms-2">
                      <%= button_to '削除', 
                          speaker_dashboard_talk_session_question_answer_delete_path(
                            talk_id: question.talk.id, 
                            session_question_id: question.id, 
                            id: answer.id, 
                            event: @conference&.abbr || event_name
                          ), 
                          method: :delete, 
                          class: 'btn btn-sm btn-danger',
                          data: { turbo_confirm: '本当に削除しますか？' } %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <!-- 回答フォーム -->
    <%= turbo_frame_tag "answer_form_#{question.id}" do %>
      <%= form_with url: speaker_dashboard_talk_session_question_answer_path(talk_id: question.talk.id, session_question_id: question.id, event: @conference&.abbr || event_name), method: :post, class: 'mt-2' do |f| %>
        <div class="mb-2">
          <%= f.text_area :body, class: 'form-control form-control-sm', rows: 2, placeholder: '回答を入力してください（最大512文字）', maxlength: 512, required: true %>
        </div>
        <%= f.submit '回答する', class: 'btn btn-primary btn-sm' %>
      <% end %>
    <% end %>
  </div>
<% end %>
